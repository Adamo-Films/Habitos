<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Danilo no 🎮</title>
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Bebas+Neue:400&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Antonio:wght@100&family=Inter:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Bungee&display=swap" rel="stylesheet">
  <style>
    :root {
      --gold: #ffe379;
      --gold2: #e4c145;
      --gold3: #f7e399;
      --corpo: #191919;
      --day-inactive: #f2f2f7;
      --header-height: 190px;
      --header-shrink: 62px;
      --neon-purple: #cf28ff;
      --neon-pink: #ff49e1;
      --neon-blue: #51ffe7;
      --shadow-purple: #9800cc;
    }
    html, body { height: 100%; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', Arial, sans-serif;
      background: var(--corpo);
      color: var(--day-inactive);
      min-height: 100vh;
      transition: background 0.3s;
    }
    .banner-gamer {
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      margin-top: 32px;
      margin-bottom: 0px;
      z-index: 10;
      pointer-events: none;
      user-select: none;
    }
    .banner-gamer-img {
      max-width: 540px;
      width: 100%;
      height: auto;
      display: block;
      filter: drop-shadow(0 8px 38px #19e0fc88)
              drop-shadow(0 1px 18px #ff38fd88)
              drop-shadow(0 0 20px #0008);
      pointer-events: none;
      user-select: none;
    }
    @media (max-width: 700px) {
      .banner-gamer-img { max-width: 97vw; }
      .banner-gamer { margin-top: 8px; }
    }
    .container {
      max-width: 1300px;
      margin: 0 auto;
      padding: 0 32px;
    }

    /* REWARD CARD GAMIFICADO */
    .reward-card {
      margin: 46px auto 0 auto;
      max-width: 560px;
      width: 100%;
      background: #251b37;
      border-radius: 24px;
      box-shadow: 0 6px 32px #9800cc55, 0 1px 18px #0ff5, 0 0 0 3px #cf28ff44;
      padding: 28px 28px 24px 28px;
      text-align: center;
      position: relative;
      overflow: visible;
      z-index: 20;
      border-top: 4px solid var(--neon-purple);
      border-bottom: 3px solid var(--neon-blue);
      background-image: linear-gradient(130deg, #281d40 74%, #3f0a57 100%);
      margin-bottom: 18px;
      pointer-events: auto;
    }
    .reward-card .title {
      font-family: 'Bungee', 'Bebas Neue', Arial, sans-serif;
      font-size: 2.1em;
      color: #fff;
      letter-spacing: 0.06em;
      margin-bottom: 0.2em;
      text-shadow: 0 0 20px var(--neon-purple), 0 0 3px #000;
    }
    .reward-card .desc {
      font-size: 1.1em;
      color: #d7b6fc;
      margin-bottom: 10px;
      letter-spacing: 0.01em;
      font-weight: 600;
      text-shadow: 0 0 7px #2f024e77;
    }
    .reward-bar-bg {
      background: #201126;
      border-radius: 18px;
      height: 28px;
      margin: 22px auto 10px auto;
      width: 98%;
      box-shadow: 0 0 14px #a41ec0a8, 0 0 24px #31e8ff13;
      position: relative;
      overflow: hidden;
      z-index: 1;
      border: 1.2px solid #4e207c;
    }
    .reward-bar {
      background: linear-gradient(90deg,
        var(--neon-purple) 10%,
        var(--neon-pink) 48%,
        var(--neon-blue) 100%);
      height: 100%;
      border-radius: 16px;
      width: 0%;
      box-shadow:
        0 0 32px 10px #ff49e1a2,
        0 0 26px 8px #cf28ff66,
        0 0 5px 2px #51ffe780;
      transition: width 0.8s cubic-bezier(.59,1.5,.32,1.01);
      position: relative;
      z-index: 2;
      overflow: visible;
      animation: neonPulse 2.2s infinite alternate;
    }
    @keyframes neonPulse {
      0% { filter: drop-shadow(0 0 10px #fff7) drop-shadow(0 0 0px #cf28ff77); }
      100% { filter: drop-shadow(0 0 27px #cf28ff) drop-shadow(0 0 9px #51ffe7); }
    }
    .reward-icon {
      font-size: 2.8em;
      margin-bottom: 0.14em;
      display: inline-block;
      filter: drop-shadow(0 0 12px #cf28ff) drop-shadow(0 0 16px #ff49e1cc);
      animation: iconGlow 1.8s infinite alternate;
    }
    @keyframes iconGlow {
      0% { filter: drop-shadow(0 0 5px #cf28ff77); }
      100% { filter: drop-shadow(0 0 16px #ff49e1cc) drop-shadow(0 0 36px #51ffe7); }
    }
    .reward-unlocked {
      color: var(--neon-blue);
      font-size: 1.25em;
      font-weight: bold;
      letter-spacing: 0.09em;
      margin-top: 6px;
      text-shadow: 0 0 17px #0ff, 0 1px 4px #cf28ff99;
      transition: color 0.5s;
      animation: celebrateText 1.6s cubic-bezier(.22,1.5,.5,1.02);
    }
    /* =============== */
    .mes {
      font-family: 'Antonio', Arial Narrow, Arial, sans-serif;
      font-size: 2.06em;
      margin: 42px 0 13px;
      border-bottom: 2px solid #f9c74f;
      padding-bottom: 5px;
      letter-spacing: 0.11em;
      color: #f9c74f;
      text-shadow: 0 3px 13px #0009;
      text-align: left;
    }
    #calendario .mes:first-child { margin-top: 0; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 40px;
      background: none;
      border-radius: 18px;
      overflow: hidden;
      font-family: 'Inter', Arial, sans-serif;
      font-size: 1.09em;
      font-weight: 400;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #333;
      vertical-align: middle;
      z-index: 2;
      background: transparent !important;
    }
    th {
      background-color: #1e1e1e !important;
      color: #f9c74f !important;
      font-size: 1.06em;
      font-weight: 700;
      letter-spacing: 0.02em;
      z-index: 2;
    }
    tr.main-row {
      cursor: pointer;
      transition: background 0.2s;
      position: relative;
      --progress: 0;
      background: linear-gradient(
        90deg,
        var(--gold) 0%,
        var(--gold2) 45%,
        var(--gold3) 100%
      );
      background-size: calc(var(--progress, 0) * 100%) 100%;
      background-repeat: no-repeat;
      background-position: left top;
      box-shadow: 0 2px 10px 0 #0008;
      color: #dedede !important;
    }
    tr.main-row.day-complete {
      color: #201d09 !important;
      font-weight: bold;
      letter-spacing: 1.1px;
      text-shadow: 0 1px 2px #fff7, 0 0 4px #ffe37944, 0 2px 4px #e4c14566;
      border-left: 4px solid var(--gold2);
      border-right: 2px solid var(--gold3);
      border-radius: 2px;
      box-shadow: 0 0 5px 0 var(--gold2), 0 2px 12px 2px #ffe37980, 0 0 0 2px #e4c14570 inset;
      background-size: 100% 100% !important;
      color: #222 !important;
    }
    tr.main-row:not(.day-complete)::after {
      content: "";
      position: absolute;
      inset: 0;
      background: rgba(30,30,30,0.0);
      pointer-events: none;
      z-index: 1;
      border-radius: 1.5px;
      transition: background 0.3s;
    }
    tr.main-row.day-complete::after {
      background: transparent;
    }
    tr.main-row:hover { filter: brightness(1.08); }
    .expand-icon { display: inline-block; width: 16px; transition: transform 0.2s; }
    .main-row.expanded > .expand-icon { transform: rotate(90deg); }
    .dropdown { display: none; transition: all 0.45s cubic-bezier(.4,1.2,.23,1.05); animation: none; height: 0; padding: 0; }
    .dropdown.active { display: table-row; animation: slideDown 0.35s cubic-bezier(.2,1.1,.42,1.09); height: auto; }
    @keyframes slideDown {
      0% { opacity: 0; transform: translateY(-28px) scaleY(0.7); }
      70% { opacity: 1; transform: translateY(5px) scaleY(1.09); }
      100% { opacity: 1; transform: translateY(0) scaleY(1); }
    }
    .dropdown.drop-up { animation: slideUp 0.44s cubic-bezier(.2,1.2,.42,1.01); }
    @keyframes slideUp {
      0% { opacity: 1; transform: translateY(0) scaleY(1); }
      100% { opacity: 0; transform: translateY(-38px) scaleY(0.65); }
    }
    .dropdown > td { padding: 0; }
    .habit-list {
      margin: 16px 0 18px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      width: 100%;
    }
    .habit-item {
      display: grid;
      grid-template-columns: 52px 1fr 46px;
      align-items: center;
      width: 100%;
      min-width: 340px;
      max-width: 500px;
      background: none;
      border-radius: 9px;
      padding: 4px 8px 4px 2px;
      margin-bottom: 0;
      transition: background 0.22s, box-shadow 0.22s;
      color: #fafbfc !important;
      box-sizing: border-box;
    }
    .habit-item.habit-complete {
      background: linear-gradient(90deg, var(--gold3) 2%, var(--gold2) 40%, var(--gold) 99%);
      box-shadow: 0 2px 15px 0 #ffe37955;
      color: #232201 !important;
      font-weight: 700;
    }
    .habit-emoji {
      font-size: 1.7em;
      min-width: 40px;
      min-height: 38px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 5px;
      margin-left: 2px;
      text-align: center;
      cursor: pointer;
      user-select: none;
      filter: drop-shadow(0 2px 6px #0006);
      background: none !important;
      border-radius: 0 !important;
      box-shadow: none !important;
      border: none !important;
      transition: transform 0.18s, filter 0.17s, box-shadow 0.17s;
      position: relative;
      z-index: 3;
      vertical-align: middle;
      color: #fff !important;
      justify-self: start;
    }
    .habit-emoji:hover,
    .habit-emoji.glow {
      animation: emoji-bounce 0.5s cubic-bezier(.24,-0.06,.41,1.37) 1;
      filter: drop-shadow(0 0 10px #39e6ff) drop-shadow(0 0 16px #2363ffbb);
      box-shadow: none;
      background: none;
    }
    @keyframes emoji-bounce {
      0%   { transform: scale(1) rotate(0); }
      30%  { transform: scale(1.19) rotate(-17deg); }
      55%  { transform: scale(0.94) rotate(15deg); }
      70%  { transform: scale(1.13) rotate(-9deg); }
      100% { transform: scale(1) rotate(0); }
    }
    .habit-label {
      font-size: 1.12em;
      color: #fff !important;
      letter-spacing: 0.04em;
      font-family: 'Inter', Arial, sans-serif;
      display: flex;
      align-items: center;
      vertical-align: middle;
      transition: color 0.19s;
      padding: 0 8px;
      min-width: 110px;
      max-width: 340px;
      flex: 1 1 auto;
      justify-self: stretch;
      word-break: break-word;
    }
    .habit-done { text-decoration: line-through; color: #888 !important; }
    .habit-checkbox {
      transform: scale(1.18);
      cursor: pointer;
      margin-left: 8px;
      margin-right: 8px;
      accent-color: #ffe379;
      vertical-align: middle;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 38px;
      justify-self: end;
    }
    /* Confetti canvas */
    #confetti-canvas {
      position: fixed;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      z-index: 9999;
      display: none;
    }
    #reward-confetti {
      position: fixed;
      left: 0; top: 0; width: 100vw; height: 100vh;
      pointer-events: none; z-index: 99998; display: none;
      mix-blend-mode: lighten;
    }
    #celebrate-text {
      display: none;
      position: fixed;
      left: 50%;
      top: 38%;
      transform: translate(-50%, -50%);
      font-size: 5vw;
      color: #0a355b;
      text-shadow: 0 0 7px #fff, 0 0 28px #ffe379, 0 0 90px #ccaa33;
      font-weight: bold;
      z-index: 10000;
      pointer-events: none;
      font-family: 'Luckiest Guy', 'Antonio', Arial Narrow, Arial, sans-serif;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      animation: celebrateText 2.5s ease-out;
      background: none !important;
      border: none !important;
      border-radius: 0 !important;
      padding: 0 18px 0 18px;
    }
    @keyframes celebrateText {
      0%   { transform: translate(-50%, -50%) scale(0.7); opacity: 0; }
      50%  { transform: translate(-50%, -56%) scale(1.12); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }
  </style>
</head>
<body>
<div class="banner-gamer">
  <img src="https://i.imgur.com/Krb7yXe.png" alt="" class="banner-gamer-img">
</div>
<div class="container">
  <div id="calendario"></div>
</div>
<canvas id="confetti-canvas"></canvas>
<canvas id="reward-confetti"></canvas>
<div id="celebrate-text">VAI MLK!!!</div>
<audio id="celebrate-audio">
  <source src="https://cdn.jsdelivr.net/gh/napthedev/short-audio/success.mp3" type="audio/mpeg">
  <source src="https://cdn.jsdelivr.net/gh/napthedev/short-audio/success.ogg" type="audio/ogg">
</audio>

<!-- Firebase (Compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAMnk4nDBd6nbvt9ElZeKDlJA7cp2vYfIk",
    authDomain: "habitos-danilo.firebaseapp.com",
    projectId: "habitos-danilo",
    storageBucket: "habitos-danilo.appspot.com",
    messagingSenderId: "342699648229",
    appId: "1:342699648229:web:a22b4706e2dde3c1c1200c",
    measurementId: "G-5589029JGV"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
</script>
<script>
  // Recompensas do mês
  const rewards = [
    {
      month: 5,
      year: 2025,
      icon: "🛋️",
      title: "Prêmio Maio",
      desc: "Um dia só pra curtir e não fazer nada.",
      label: "Dia de folga!"
    },
    {
      month: 6,
      year: 2025,
      icon: "🍝",
      title: "Prêmio Junho",
      desc: "Jantar especial no restaurante Rascal.",
      label: "Rascal!"
    },
    {
      month: 7,
      year: 2025,
      icon: "🏡",
      title: "Prêmio Julho",
      desc: "Airbnb relaxante para recarregar as energias.",
      label: "Airbnb relax!"
    },
    {
      day: 21,
      month: 8,
      year: 2025,
      icon: "🧠🎲",
      title: "Meu Aniversário!",
      desc: "Jogo Turing Machine.",
      label: "Turing Machine!"
    }
  ];

  function getRewardFor(month, year, day = null) {
    if(day) {
      return rewards.find(r => r.day === day && r.month === month && r.year === year);
    }
    return rewards.find(r => r.month === month && r.year === year && !r.day);
  }

  function unlockScroll() {
    document.body.style.overflow = "";
    document.documentElement.style.overflow = "";
  }

  // EMOJIS para cada hábito
  const habitEmojis = [
    "💧", "🤳", "⚖️", "🥗", "⏰", "🧘", "🏋️", "📚", "🍫🚫", "🇮🇹",
  ];
  const cycleEmojis = ["💬", "🚿", "🧠", "🙏"];

  // CONFETTI
  function launchConfettiEpic() {
    const canvas = document.getElementById('confetti-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    canvas.style.display = 'block';
    document.body.style.overflow = "hidden";
    let W = canvas.width, H = canvas.height;
    let particles = [];
    let colors = ['#ffe379','#e4c145','#f7e399','#FF522E','#fafff9','#FFD700','#FF69B4','#00E6F6','#82FF6A','#FF6666','#0ed156','#001130','#fd2a49'];
    for (let i = 0; i < 1200; i++) {
      particles.push({
        x: Math.random() * W,
        y: Math.random() * -H,
        r: 7 + Math.random() * 12,
        d: Math.random() * 180,
        color: colors[Math.floor(Math.random() * colors.length)],
        tilt: Math.random() * 16 - 8,
        tiltAngle: 0,
        tiltAngleIncremental: (Math.random() * 0.09) + .05,
        alpha: 0.84 + Math.random() * 0.16
      });
    }
    let angle = 0;
    function draw() {
      ctx.clearRect(0, 0, W, H);
      for (let i = 0; i < particles.length; i++) {
        ctx.beginPath();
        ctx.lineWidth = particles[i].r / 2;
        ctx.strokeStyle = particles[i].color;
        ctx.globalAlpha = particles[i].alpha;
        ctx.moveTo(particles[i].x + particles[i].tilt + particles[i].r / 4, particles[i].y);
        ctx.lineTo(particles[i].x + particles[i].tilt, particles[i].y + particles[i].r);
        ctx.stroke();
      }
      ctx.globalAlpha = 1;
      update();
    }
    function update() {
      angle += 0.008;
      for (let i = 0; i < particles.length; i++) {
        particles[i].y += (Math.cos(angle + particles[i].d) + 2.8 + particles[i].r/6) * 0.93;
        particles[i].x += Math.sin(angle * 1.18 + i) * 2.7;
        particles[i].tiltAngle += particles[i].tiltAngleIncremental;
        particles[i].tilt = Math.sin(particles[i].tiltAngle - (i % 3)) * 18;
        if (particles[i].y > H + 30) {
          particles[i].y = -14;
          particles[i].x = Math.random() * W;
        }
      }
    }
    let interval = setInterval(draw, 13);
    const celebrateText = document.getElementById('celebrate-text');
    celebrateText.style.display = 'block';
    setTimeout(() => {
      clearInterval(interval);
      ctx.clearRect(0, 0, W, H);
      canvas.style.display = 'none';
      celebrateText.style.display = 'none';
      unlockScroll();
    }, 4000);
  }

  // Confetti especial (roxo) para recompensa
  function launchRewardConfetti() {
    const canvas = document.getElementById('reward-confetti');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    canvas.style.display = 'block';
    let W = canvas.width, H = canvas.height;
    let particles = [];
    let colors = ['#cf28ff', '#ff49e1', '#51ffe7', '#fff', '#9800cc', '#29012e'];
    for (let i = 0; i < 800; i++) {
      particles.push({
        x: Math.random() * W,
        y: Math.random() * -H,
        r: 8 + Math.random() * 10,
        d: Math.random() * 160,
        color: colors[Math.floor(Math.random() * colors.length)],
        tilt: Math.random() * 20 - 10,
        tiltAngle: 0,
        tiltAngleIncremental: (Math.random() * 0.07) + .06,
        alpha: 0.82 + Math.random() * 0.18
      });
    }
    let angle = 0;
    function draw() {
      ctx.clearRect(0, 0, W, H);
      for (let i = 0; i < particles.length; i++) {
        ctx.beginPath();
        ctx.lineWidth = particles[i].r / 2;
        ctx.strokeStyle = particles[i].color;
        ctx.globalAlpha = particles[i].alpha;
        ctx.moveTo(particles[i].x + particles[i].tilt + particles[i].r / 4, particles[i].y);
        ctx.lineTo(particles[i].x + particles[i].tilt, particles[i].y + particles[i].r);
        ctx.stroke();
      }
      ctx.globalAlpha = 1;
      update();
    }
    function update() {
      angle += 0.01;
      for (let i = 0; i < particles.length; i++) {
        particles[i].y += (Math.cos(angle + particles[i].d) + 2.5 + particles[i].r/6) * 0.84;
        particles[i].x += Math.sin(angle * 1.07 + i) * 2.3;
        particles[i].tiltAngle += particles[i].tiltAngleIncremental;
        particles[i].tilt = Math.sin(particles[i].tiltAngle - (i % 2)) * 19;
        if (particles[i].y > H + 30) {
          particles[i].y = -14;
          particles[i].x = Math.random() * W;
        }
      }
    }
    let interval = setInterval(draw, 13);
    setTimeout(() => {
      clearInterval(interval);
      ctx.clearRect(0, 0, W, H);
      canvas.style.display = 'none';
    }, 3400);
  }

 async function getProgress() {
    try {
      const doc = await db.collection("usuarios").doc("danilo").get();
      return doc.exists ? doc.data() : {};
    } catch (e) {
      console.error("Erro ao buscar dados do Firebase:", e);
      return JSON.parse(localStorage.getItem('habits-progress-v1')) || {};
    }
  }

  async function saveProgress(progress) {
    try {
      await db.collection("usuarios").doc("danilo").set(progress);
    } catch (e) {
      console.error("Erro ao salvar no Firebase:", e);
    }
    localStorage.setItem('habits-progress-v1', JSON.stringify(progress));
  }

 document.addEventListener("DOMContentLoaded", async function() {
  const progress = await getProgress();
    const dados = [];
    const habitos_incrementais = {
      1: ["Beber 2L de água", "Tirar selfie", "Verificar peso"],
      5: ["Dieta com alimentos integrais"],
      9: ["Acordar às 5h"],
      13: ["Meditação (10 min por dia)"],
      17: ["Exercício (60 min)"],
      21: ["Leitura (30 min)"],
      25: ["Alimentação sem açúcar refinado"],
      29: ["Prática de italiano (20 min por dia)"]
    };
    const habitos_ciclicos = ["Afirmações", "Banho gelado", "Exercício de agilidade mental", "Diário e gratidão"];
    const inicio = new Date(2025, 4, 21), fim = new Date(2025, 7, 21);
    const dias_total = Math.floor((fim - inicio) / (1000 * 60 * 60 * 24)) + 1;
    let habitos_ativos = [];
    for (let i = 1; i <= dias_total; i++) {
      const data_atual = new Date(inicio);
      data_atual.setDate(inicio.getDate() + i - 1);
      if (habitos_incrementais[i]) {
        habitos_ativos = habitos_ativos.concat(habitos_incrementais[i]);
      }
      const habito_ciclico = habitos_ciclicos[(i - 1) % 4];
      dados.push({
        data: data_atual.toLocaleDateString('pt-BR'),
        dia: `Dia ${i}`,
        habitos: [...habitos_ativos],
        ciclico: habito_ciclico,
        mes: data_atual.getMonth() + 1,
        ano: data_atual.getFullYear(),
        diaDoMes: data_atual.getDate(),
        id: `dia-${data_atual.getFullYear()}-${data_atual.getMonth()+1}-${data_atual.getDate()}`
      });
    }
    const calendario = document.getElementById("calendario");
    const grupos = {};
    dados.forEach((obj) => {
    const id = `${(obj.mes).toString().padStart(2, '0')}-${obj.ano}`;
      if (!grupos[id]) grupos[id] = [];
      grupos[id].push(obj);
    });
       let html = '';
    // Nomes dos meses fixos, 0-based
    const mesNomes = [
      "JANEIRO", "FEVEREIRO", "MARÇO", "ABRIL", "MAIO", "JUNHO",
      "JULHO", "AGOSTO", "SETEMBRO", "OUTUBRO", "NOVEMBRO", "DEZEMBRO"
    ];

    Object.entries(grupos).forEach(([id, dias]) => {
      const [mes, ano] = id.split("-");
      // Usa array de nomes de mês fixo, corrige qualquer bug de data!
      const nomeMes = mesNomes[parseInt(mes, 10) - 1];

      // Adiciona o nome do mês e a tabela normalmente:
      html += `<div class='mes'>${nomeMes} ${ano}</div>
      <table>
        <thead>
          <tr>
            <th></th>
            <th>Data</th>
            <th>Dia</th>
            <th>Hábitos Diários</th>
            <th>Hábito Cíclico</th>
          </tr>
        </thead>
        <tbody>`;

      dias.forEach((dia) => {
        const dayNum = parseInt(dia.dia.substring(4));
        let habitosCellText;
        if (dayNum <= 4) {
          habitosCellText = dia.habitos.join(', ');
        } else if (habitos_incrementais[dayNum]) {
          const newHabs = habitos_incrementais[dayNum];
          const totalBefore = dia.habitos.length - newHabs.length;
          habitosCellText = `${totalBefore} ${totalBefore > 1 ? 'hábitos' : 'hábito'} + ${newHabs.join(', ')}`;
        } else {
          const total = dia.habitos.length;
          habitosCellText = `${total} ${total > 1 ? 'hábitos' : 'hábito'}`;
        }
        html += `
        <tr class="main-row" data-dropdown="${dia.id}" id="mainrow-${dia.id}" style="--progress:0">
          <td><span class="expand-icon">&#9654;</span></td>
          <td class="progress-text gold">${dia.data}</td>
          <td class="progress-text gold">${dia.dia}</td>
          <td class="progress-text gold">${habitosCellText}</td>
          <td class="progress-text gold">${dia.ciclico}</td>
        </tr>
        <tr class="dropdown" id="dropdown-${dia.id}">
          <td colspan="5">
            <div class="habit-list">
              ${dia.habitos.map((h, idx) => `
                <div class="habit-item" id="habititem-${dia.id}-habit-${idx}">
                  <span class="habit-emoji" tabindex="0" data-checkbox="${dia.id}-habit-${idx}">${habitEmojis[idx % habitEmojis.length]}</span>
                  <label class="habit-label" for="${dia.id}-habit-${idx}" id="label-${dia.id}-habit-${idx}">${h}</label>
                  <input type="checkbox" class="habit-checkbox" id="${dia.id}-habit-${idx}">
                </div>
              `).join('')}
              <div class="habit-item" id="habititem-${dia.id}-ciclico">
                <span class="habit-emoji" tabindex="0" data-checkbox="${dia.id}-ciclico">${cycleEmojis[(dia.mes + dia.ano) % cycleEmojis.length]}</span>
                <label class="habit-label" for="${dia.id}-ciclico" id="label-${dia.id}-ciclico">${dia.ciclico}</label>
                <input type="checkbox" class="habit-checkbox" id="${dia.id}-ciclico">
              </div>
            </div>
          </td>
        </tr>`;
      });

      html += `</tbody></table>`;

      // Card de prêmio após a tabela
      const reward = getRewardFor(Number(mes), Number(ano));
      if (reward) {
        html += `
          <div class="reward-card" data-reward="${mes}-${ano}">
            <div class="reward-icon">${reward.icon}</div>
            <div class="title">${reward.title}</div>
            <div class="desc">${reward.desc}</div>
            <div class="reward-bar-bg"><div class="reward-bar" id="reward-bar-${mes}-${ano}"></div></div>
            <div class="reward-unlocked" id="reward-unlocked-${mes}-${ano}" style="display:none">
              Prêmio desbloqueado: <span>${reward.label}</span>
            </div>
          </div>
        `;
      }

      // Card de aniversário (se for agosto 2025):
      if (mes == 8 && ano == 2025) {
        const annivReward = getRewardFor(Number(mes), Number(ano), 21);
        if (annivReward) {
          html += `
            <div class="reward-card" data-reward="birthday-2025">
              <div class="reward-icon">${annivReward.icon}</div>
              <div class="title">${annivReward.title}</div>
              <div class="desc">${annivReward.desc}</div>
              <div class="reward-bar-bg"><div class="reward-bar" id="reward-bar-birthday"></div></div>
              <div class="reward-unlocked" id="reward-unlocked-birthday" style="display:none">
                Prêmio desbloqueado: <span>${annivReward.label}</span>
              </div>
            </div>
          `;
        }
      }
    });
    calendario.innerHTML = html;

    // Dropdown toggle
    document.querySelectorAll('tr.main-row').forEach(row => {
      row.addEventListener('click', function(e) {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'LABEL' || e.target.classList.contains('habit-emoji')) return;
        const dropdownId = this.getAttribute('data-dropdown');
        const dropdown = document.getElementById(`dropdown-${dropdownId}`);
        if (dropdown.classList.contains('active')) {
          dropdown.classList.remove('active');
          dropdown.classList.add('drop-up');
          setTimeout(() => dropdown.classList.remove('drop-up'), 400);
          this.classList.remove('expanded');
        } else {
          document.querySelectorAll('.dropdown.active').forEach(dd => {
            dd.classList.remove('active');
            dd.classList.add('drop-up');
            setTimeout(() => dd.classList.remove('drop-up'), 400);
            document.querySelector(`.main-row[data-dropdown="${dd.id.replace('dropdown-','')}"]`).classList.remove('expanded');
          });
          dropdown.classList.add('active');
          dropdown.classList.remove('drop-up');
          this.classList.add('expanded');
        }
      });
    });

    function checkAllHabitsComplete(dayId, habitCount) {
      let complete = true;
      for (let i = 0; i < habitCount; i++) {
        if (!document.getElementById(`${dayId}-habit-${i}`)?.checked) {
          complete = false;
          break;
        }
      }
      if (complete && !document.getElementById(`${dayId}-ciclico`)?.checked) complete = false;
      return complete;
    }

    function playCelebrateSound() {
      const audio = document.getElementById('celebrate-audio');
      audio.currentTime = 0;
      audio.volume = 0.97;
      let played = false;
      audio.play().then(() => { played = true; }).catch(() => {
        if (!played) {
          document.body.addEventListener('pointerdown', () => { audio.play(); }, { once: true });
        }
      });
    }

   document.querySelectorAll('.habit-checkbox').forEach(checkbox => {
  checkbox.addEventListener('change', function() {
    const label = document.getElementById('label-' + this.id);
    if (label) label.classList.toggle('habit-done', this.checked);

    getProgress().then(progress => {
      progress[this.id] = this.checked;
      saveProgress(progress);
    });

    const hi = document.getElementById('habititem-' + this.id);
    if (hi) hi.classList.toggle('habit-complete', this.checked);
        const parts = this.id.match(/^dia-\d+-\d+-\d+/);
        if (parts) {
          const dayId = parts[0];
          const habitCount = document.querySelectorAll(`#dropdown-${dayId} .habit-checkbox`).length;
          updateProgressBar(dayId, habitCount);
          const allDone = checkAllHabitsComplete(dayId, habitCount - 1);
          const dropdown = document.getElementById(`dropdown-${dayId}`);
          const dayRow = document.getElementById(`mainrow-${dayId}`);
          if (allDone) {
            dayRow.classList.add('day-complete');
            launchConfettiEpic();
            playCelebrateSound();
            setTimeout(() => {
              if (dropdown) {
                dropdown.classList.remove('active');
                dropdown.classList.add('drop-up');
                setTimeout(() => dropdown.classList.remove('drop-up'), 400);
              }
              if (dayRow) dayRow.classList.remove('expanded');
              unlockScroll();
            }, 950);
          } else {
            dayRow.classList.remove('day-complete');
          }
          // Atualizar barras de recompensa
          updateAllRewardProgress();
        }
      });
    });

    document.querySelectorAll('.habit-emoji').forEach(emoji => {
      emoji.addEventListener('mouseenter', function() {
        emoji.classList.add('glow');
        setTimeout(() => emoji.classList.remove('glow'), 680);
      });
      emoji.addEventListener('mouseleave', function() {
        emoji.classList.remove('glow');
      });
      emoji.addEventListener('click', function(e) {
        e.stopPropagation();
        const id = emoji.getAttribute('data-checkbox');
        const checkbox = document.getElementById(id);
        if (checkbox) {
          checkbox.checked = !checkbox.checked;
          checkbox.dispatchEvent(new Event('change'));
        }
      });
    });

    // Progress bar e checagem para todos os dias e prêmios!
    dados.forEach((dia) => {
      const habitCount = dia.habitos.length + 1;
      updateProgressBar(dia.id, habitCount);
      const allDone = checkAllHabitsComplete(dia.id, habitCount - 1);
      if (allDone) {
        const dayRow = document.getElementById(`mainrow-${dia.id}`);
        if (dayRow) dayRow.classList.add('day-complete');
      }
    });

    function updateAllRewardProgress() {
      // Atualiza a barra de cada mês
const mesNomes = [
  "JANEIRO", "FEVEREIRO", "MARÇO", "ABRIL", "MAIO", "JUNHO",
  "JULHO", "AGOSTO", "SETEMBRO", "OUTUBRO", "NOVEMBRO", "DEZEMBRO"
];

Object.entries(grupos).forEach(([id, dias]) => {
  const [mes, ano] = id.split("-");
  const nomeMes = mesNomes[parseInt(mes, 10) - 1];
        const reward = getRewardFor(Number(mes), Number(ano));
        if (!reward) return;
        let diasCompletos = 0;
        dias.forEach((dia) => {
          const habitCount = dia.habitos.length + 1;
          const allDone = checkAllHabitsComplete(dia.id, habitCount - 1);
          if (allDone) diasCompletos++;
        });
        updateRewardProgress(mes, ano, dias.length, diasCompletos);
      });
      // Aniversário
      if(document.getElementById("reward-bar-birthday")) {
        // Só desbloqueia se dia 21/08/2025 for completado
        let birthdayDone = false;
        dados.forEach((dia)=>{
          if(dia.ano == 2025 && dia.mes == 8 && dia.diaDoMes == 21) {
            const habitCount = dia.habitos.length + 1;
            birthdayDone = checkAllHabitsComplete(dia.id, habitCount - 1);
          }
        });
        updateBirthdayRewardProgress(birthdayDone);
      }
    }
    updateAllRewardProgress();

    window.addEventListener('resize', function() {
      const canvas = document.getElementById('confetti-canvas');
      if (canvas.style.display === 'block') {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      }
    });
  });
</script>
</body>
</html>
