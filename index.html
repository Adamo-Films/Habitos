<!DOCTYPE html>
<html lang="pt-br">
<head>
  <link href="https://fonts.googleapis.com/css2?family=Bungee&display=swap" rel="stylesheet">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Danilo no üéÆ</title>
  <link href="https://fonts.googleapis.com/css?family=Bebas+Neue:400&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Antonio:wght@100&family=Inter:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&display=swap" rel="stylesheet">
  <style>
:root {
  --gold: #ffe379;
  --gold2: #e4c145;
  --gold3: #f7e399;
  --corpo: #191919;
  --day-inactive: #f2f2f7;
  --header-height: 190px;
  --header-shrink: 62px;
  --neon-purple: #cf28ff;
  --neon-pink: #ff49e1;
  --neon-blue: #51ffe7;
  --shadow-purple: #9800cc;
}
html, body { height: 100%; margin: 0; padding: 0; }
body {
  font-family: 'Inter', Arial, sans-serif;
  background: var(--corpo);
  color: var(--day-inactive);
  min-height: 100vh;
  transition: background 0.3s;
}
.banner-gamer {
  width: 100%;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  margin-top: 32px;
  margin-bottom: 0px;
  z-index: 10;
  pointer-events: none;
  user-select: none;
}
.banner-gamer-img {
  max-width: 540px;
  width: 100%;
  height: auto;
  display: block;
  filter: drop-shadow(0 8px 38px #19e0fc88)
          drop-shadow(0 1px 18px #ff38fd88)
          drop-shadow(0 0 20px #0008);
  pointer-events: none;
  user-select: none;
}
@media (max-width: 700px) {
  .banner-gamer-img { max-width: 97vw; }
  .banner-gamer { margin-top: 8px; }
}
.container {
  max-width: 1300px;
  margin: 0 auto;
  padding: 0 32px;
}
/* M√äS */
.mes {
  font-family: 'Antonio', Arial Narrow, Arial, sans-serif;
  font-size: 2.06em;
  margin: 42px 0 13px;
  border-bottom: 2px solid #f9c74f;
  padding-bottom: 5px;
  letter-spacing: 0.11em;
  color: #f9c74f;
  text-shadow: 0 3px 13px #0009;
  text-align: left;
}
#calendario .mes:first-child { margin-top: 0; }
table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 40px;
  background: none;
  border-radius: 18px;
  overflow: hidden;
  font-family: 'Inter', Arial, sans-serif;
  font-size: 1.09em;
  font-weight: 400;
}
th, td {
  padding: 12px;
  text-align: left;
  border-bottom: 1px solid #333;
  vertical-align: middle;
  z-index: 2;
  background: transparent !important;
}
th {
  background-color: #1e1e1e !important;
  color: #f9c74f !important;
  font-size: 1.06em;
  font-weight: 700;
  letter-spacing: 0.02em;
  z-index: 2;
}
/* PROGRESS ROW BARRA INTEIRA */
.progress-row {
  position: relative;
  width: 100%;
  border-radius: 5px;
  overflow: hidden;
  background: #191919;
  min-height: 40px;
  margin-bottom: 0;
  margin-top: 0;
  box-shadow: 0 2px 10px #0008;
}
.progress-bar-bg {
  width: 100%;
  height: 100%;
  position: absolute;
  left: 0; top: 0;
  background: none;
  z-index: 1;
}
.progress-bar-gold {
  height: 100%;
  background: linear-gradient(90deg, var(--gold) 0%, var(--gold2) 45%, var(--gold3) 100%);
  position: absolute;
  left: 0; top: 0;
  width: 0%;
  z-index: 2;
  transition: width 0.8s cubic-bezier(.59,1.5,.32,1.01);
  opacity: 0.82;
}
.progress-row-content {
  position: relative;
  display: flex;
  flex-direction: row;
  justify-content: flex-start;
  align-items: center;
  z-index: 3;
}
.progress-row-content > div {
  flex: 1 1 0;
  padding: 7px 10px;
  font-weight: bold;
  color: #fff;
  font-size: 1.01em;
  letter-spacing: 0.01em;
  white-space: pre-line;
}
.progress-row.day-complete .progress-row-content > div {
  color: #201d09 !important;
  text-shadow: 0 1px 2px #fff7, 0 0 4px #ffe37944, 0 2px 4px #e4c14566;
}
@media (max-width: 800px) {
  .progress-row-content > div { font-size: 0.98em; padding: 7px 5px; }
}
@media (max-width: 500px) {
  .progress-row-content > div { font-size: 0.89em; padding: 7px 2px; }
}

/* DROPDOWN HABITS (sem altera√ß√£o) */
.dropdown > td { padding: 0; }
.habit-list {
  margin: 16px 0 18px 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  width: 100%;
}
.habit-item {
  display: grid;
  grid-template-columns: 52px 1fr 46px;
  align-items: center;
  width: 100%;
  min-width: 340px;
  max-width: 500px;
  background: none;
  border-radius: 9px;
  padding: 4px 8px 4px 2px;
  margin-bottom: 0;
  transition: background 0.22s, box-shadow 0.22s;
  color: #fafbfc !important;
  box-sizing: border-box;
}
.habit-item.habit-complete {
  background: linear-gradient(90deg, var(--gold3) 2%, var(--gold2) 40%, var(--gold) 99%);
  box-shadow: 0 2px 15px 0 #ffe37955;
  color: #232201 !important;
  font-weight: 700;
}
.habit-emoji {
  font-size: 1.7em;
  min-width: 40px;
  min-height: 38px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 5px;
  margin-left: 2px;
  text-align: center;
  cursor: pointer;
  user-select: none;
  filter: drop-shadow(0 2px 6px #0006);
  background: none !important;
  border-radius: 0 !important;
  box-shadow: none !important;
  border: none !important;
  transition: transform 0.18s, filter 0.17s, box-shadow 0.17s;
  position: relative;
  z-index: 3;
  vertical-align: middle;
  color: #fff !important;
  justify-self: start;
}
.habit-label {
  font-size: 1.12em;
  color: #fff !important;
  letter-spacing: 0.04em;
  font-family: 'Inter', Arial, sans-serif;
  display: flex;
  align-items: center;
  vertical-align: middle;
  transition: color 0.19s;
  padding: 0 8px;
  min-width: 110px;
  max-width: 340px;
  flex: 1 1 auto;
  justify-self: stretch;
  word-break: break-word;
}
.habit-done { text-decoration: line-through; color: #888 !important; }
.habit-checkbox {
  transform: scale(1.18);
  cursor: pointer;
  margin-left: 8px;
  margin-right: 8px;
  accent-color: #ffe379;
  vertical-align: middle;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 38px;
  justify-self: end;
}

/* Confetti e celebra√ß√£o (sem altera√ß√£o) */
#confetti-canvas, #reward-confetti {
  position: fixed;
  left: 0; top: 0; width: 100vw; height: 100vh;
  pointer-events: none; z-index: 9999; display: none;
}
#celebrate-text {
  display: none;
  position: fixed;
  left: 50%; top: 38%;
  transform: translate(-50%, -50%);
  font-size: 5vw;
  color: #0a355b;
  text-shadow: 0 0 7px #fff, 0 0 28px #ffe379, 0 0 90px #ccaa33;
  font-weight: bold;
  z-index: 10000;
  pointer-events: none;
  font-family: 'Luckiest Guy', 'Antonio', Arial Narrow, Arial, sans-serif;
  text-transform: uppercase;
  letter-spacing: 0.04em;
  animation: celebrateText 2.5s ease-out;
  background: none !important; border: none !important; border-radius: 0 !important; padding: 0 18px 0 18px;
}
@keyframes celebrateText {
  0%   { transform: translate(-50%, -50%) scale(0.7); opacity: 0; }
  50%  { transform: translate(-50%, -56%) scale(1.12); opacity: 1; }
  100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
}
  </style>
</head>
<body>
<div class="banner-gamer">
  <img src="https://i.imgur.com/Krb7yXe.png" alt="" class="banner-gamer-img">
</div>
<div class="container">
  <div id="calendario"></div>
</div>
<canvas id="confetti-canvas"></canvas>
<canvas id="reward-confetti"></canvas>
<div id="celebrate-text">VAI MLK!!!</div>
<audio id="celebrate-audio">
  <source src="https://cdn.jsdelivr.net/gh/napthedev/short-audio/success.mp3" type="audio/mpeg">
  <source src="https://cdn.jsdelivr.net/gh/napthedev/short-audio/success.ogg" type="audio/ogg">
</audio>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script>
// Firebase e dados (igual ao seu)
const firebaseConfig = {
  apiKey: "AIzaSyAMnk4nDBd6nbvt9ElZeKDlJA7cp2vYfIk",
  authDomain: "habitos-danilo.firebaseapp.com",
  projectId: "habitos-danilo",
  storageBucket: "habitos-danilo.appspot.com",
  messagingSenderId: "342699648229",
  appId: "1:342699648229:web:a22b4706e2dde3c1c1200c",
  measurementId: "G-5589029JGV"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const habitEmojis = ["üíß", "ü§≥", "‚öñÔ∏è", "ü•ó", "‚è∞", "üßò", "üèãÔ∏è", "üìö", "üç´üö´", "üáÆüáπ"];
const cycleEmojis = ["üí¨", "üöø", "üß†", "üôè"];
const monthNames = [
  "Janeiro", "Fevereiro", "Mar√ßo", "Abril",
  "Maio", "Junho", "Julho", "Agosto",
  "Setembro", "Outubro", "Novembro", "Dezembro"
];
const rewards = [
  { month: 5, year: 2025, icon: "üõãÔ∏è", title: "Pr√™mio Maio", desc: "Um dia s√≥ pra curtir e n√£o fazer nada.", label: "Dia de folga!" },
  { month: 6, year: 2025, icon: "üçù", title: "Pr√™mio Junho", desc: "Jantar especial no restaurante Rascal.", label: "Rascal!" },
  { month: 7, year: 2025, icon: "üè°", title: "Pr√™mio Julho", desc: "Airbnb relaxante para recarregar as energias.", label: "Airbnb relax!" },
  { day: 21, month: 8, year: 2025, icon: "üß†üé≤", title: "Meu Anivers√°rio!", desc: "Jogo Turing Machine.", label: "Turing Machine!" }
];
function getRewardFor(month, year, day = null) {
  if(day) return rewards.find(r => r.day === day && r.month === month && r.year === year);
  return rewards.find(r => r.month === month && r.year === year && !r.day);
}
function unlockScroll() { document.body.style.overflow = ""; document.documentElement.style.overflow = ""; }

// Dados de h√°bitos
async function getProgress() {
  try {
    const doc = await db.collection("usuarios").doc("danilo").get();
    return doc.exists ? doc.data() : {};
  } catch (e) {
    console.error("Erro ao buscar dados do Firebase:", e);
    return JSON.parse(localStorage.getItem('habits-progress-v1')) || {};
  }
}
async function saveProgress(progress) {
  try {
    await db.collection("usuarios").doc("danilo").set(progress);
  } catch (e) {
    console.error("Erro ao salvar no Firebase:", e);
  }
  localStorage.setItem('habits-progress-v1', JSON.stringify(progress));
}

// Gerar e desenhar tabela de h√°bitos
document.addEventListener("DOMContentLoaded", async function() {
  const progress = await getProgress();
  const dados = [];
  const habitos_incrementais = {
    1: ["Beber 2L de √°gua", "Tirar selfie", "Verificar peso"],
    5: ["Dieta com alimentos integrais"],
    9: ["Acordar √†s 5h"],
    13: ["Medita√ß√£o (10 min por dia)"],
    17: ["Exerc√≠cio (60 min)"],
    21: ["Leitura (30 min)"],
    25: ["Alimenta√ß√£o sem a√ß√∫car refinado"],
    29: ["Pr√°tica de italiano (20 min por dia)"]
  };
  const habitos_ciclicos = ["Afirma√ß√µes", "Banho gelado", "Exerc√≠cio de agilidade mental", "Di√°rio e gratid√£o"];
  const inicio = new Date(2025, 4, 21), fim = new Date(2025, 7, 21);
  const dias_total = Math.floor((fim - inicio) / (1000 * 60 * 60 * 24)) + 1;
  let habitos_ativos = [];
  for (let i = 1; i <= dias_total; i++) {
    const data_atual = new Date(inicio);
    data_atual.setDate(inicio.getDate() + i - 1);
    if (habitos_incrementais[i]) habitos_ativos = habitos_ativos.concat(habitos_incrementais[i]);
    const habito_ciclico = habitos_ciclicos[(i - 1) % 4];
    dados.push({
      data: data_atual.toLocaleDateString('pt-BR'),
      dia: `Dia ${i}`,
      habitos: [...habitos_ativos],
      ciclico: habito_ciclico,
      mes: data_atual.getMonth() + 1,
      ano: data_atual.getFullYear(),
      diaDoMes: data_atual.getDate(),
      id: `dia-${data_atual.getFullYear()}-${data_atual.getMonth()+1}-${data_atual.getDate()}`
    });
  }
  const calendario = document.getElementById("calendario");
  const grupos = {};
  dados.forEach((obj) => {
    const id = `${obj.mes}-${obj.ano}`;
    if (!grupos[id]) grupos[id] = [];
    grupos[id].push(obj);
  });
  let html = '';
  Object.entries(grupos).forEach(([id, dias]) => {
    const [mes, ano] = id.split("-");
    const mesNum = Number(mes);
    const anoNum = Number(ano);
    const nomeMes = monthNames[mesNum - 1].toUpperCase();

    // Header do m√™s
    html += `<div class='mes'>${nomeMes} ${ano}</div>
    <table>
      <thead>
        <tr>
          <th>Data</th>
          <th>Dia</th>
          <th>H√°bitos Di√°rios</th>
          <th>H√°bito C√≠clico</th>
        </tr>
      </thead>
      <tbody>`;
    dias.forEach((dia) => {
      const dayNum = parseInt(dia.dia.substring(4));
      let habitosCellText;
      if (dayNum <= 4) {
        habitosCellText = dia.habitos.join(', ');
      } else if (habitos_incrementais[dayNum]) {
        const newHabs = habitos_incrementais[dayNum];
        const totalBefore = dia.habitos.length - newHabs.length;
        habitosCellText = `${totalBefore} ${totalBefore > 1 ? 'h√°bitos' : 'h√°bito'} + ${newHabs.join(', ')}`;
      } else {
        const total = dia.habitos.length;
        habitosCellText = `${total} ${total > 1 ? 'h√°bitos' : 'h√°bito'}`;
      }
      html += `
      <tr>
        <td colspan="4" style="padding:0;">
          <div class="progress-row" id="progressrow-${dia.id}" data-dayid="${dia.id}">
            <div class="progress-bar-bg"></div>
            <div class="progress-bar-gold" id="bar-${dia.id}"></div>
            <div class="progress-row-content">
              <div>${dia.data}</div>
              <div>${dia.dia}</div>
              <div>${habitosCellText}</div>
              <div>${dia.ciclico}</div>
            </div>
          </div>
        </td>
      </tr>
      <tr class="dropdown" id="dropdown-${dia.id}">
        <td colspan="4">
          <div class="habit-list">
            ${dia.habitos.map((h, idx) => `
              <div class="habit-item" id="habititem-${dia.id}-habit-${idx}">
                <span class="habit-emoji" tabindex="0" data-checkbox="${dia.id}-habit-${idx}">${habitEmojis[idx % habitEmojis.length]}</span>
                <label class="habit-label" for="${dia.id}-habit-${idx}" id="label-${dia.id}-habit-${idx}">${h}</label>
                <input type="checkbox" class="habit-checkbox" id="${dia.id}-habit-${idx}">
              </div>
            `).join('')}
            <div class="habit-item" id="habititem-${dia.id}-ciclico">
              <span class="habit-emoji" tabindex="0" data-checkbox="${dia.id}-ciclico">${cycleEmojis[(dia.mes + dia.ano) % cycleEmojis.length]}</span>
              <label class="habit-label" for="${dia.id}-ciclico" id="label-${dia.id}-ciclico">${dia.ciclico}</label>
              <input type="checkbox" class="habit-checkbox" id="${dia.id}-ciclico">
            </div>
          </div>
        </td>
      </tr>`;
    });
    html += `</tbody></table>`;

    // Card de pr√™mio do m√™s (exceto anivers√°rio)
    const reward = getRewardFor(mesNum, anoNum);
    if(reward) {
      html += `
      <div class="reward-card" data-reward="${mes}-${ano}">
        <div class="reward-icon">${reward.icon}</div>
        <div class="title">${reward.title}</div>
        <div class="desc">${reward.desc}</div>
        <div class="reward-bar-bg"><div class="reward-bar" id="reward-bar-${mes}-${ano}"></div></div>
        <div class="reward-unlocked" id="reward-unlocked-${mes}-${ano}" style="display:none">Pr√™mio desbloqueado: <span>${reward.label}</span></div>
      </div>`;
    }
    // Card de pr√™mio especial de anivers√°rio
    if(mesNum === 8 && anoNum === 2025) {
      const annivReward = getRewardFor(mesNum, anoNum, 21);
      if(annivReward) {
        html += `
          <div class="reward-card" data-reward="birthday-2025">
            <div class="reward-icon">${annivReward.icon}</div>
            <div class="title">${annivReward.title}</div>
            <div class="desc">${annivReward.desc}</div>
            <div class="reward-bar-bg"><div class="reward-bar" id="reward-bar-birthday"></div></div>
            <div class="reward-unlocked" id="reward-unlocked-birthday" style="display:none">Pr√™mio desbloqueado: <span>${annivReward.label}</span></div>
          </div>
        `;
      }
    }
  });
  calendario.innerHTML = html;

  // Marcar checkboxes do progresso salvo
  Object.keys(progress).forEach(checkId => {
    const checkbox = document.getElementById(checkId);
    if (checkbox) {
      checkbox.checked = progress[checkId];
      const label = document.getElementById('label-' + checkId);
      if (label) label.classList.toggle('habit-done', progress[checkId]);
      const hi = document.getElementById('habititem-' + checkId);
      if (hi) hi.classList.toggle('habit-complete', progress[checkId]);
    }
  });

  // Atualiza barra de progresso da linha inteira
  function updateProgressBar(dayId, habitCount) {
    let checked = 0;
    for (let i = 0; i < habitCount; i++) {
      if (document.getElementById(`${dayId}-habit-${i}`)?.checked) checked++;
    }
    if (document.getElementById(`${dayId}-ciclico`)?.checked) checked++;
    let pct = checked / habitCount;
    const bar = document.getElementById(`bar-${dayId}`);
    const row = document.getElementById(`progressrow-${dayId}`);
    if (bar) bar.style.width = (pct * 100) + "%";
    if (row) row.classList.toggle('day-complete', pct === 1);
  }

  // Barra de progresso de recompensa por m√™s
  function updateRewardProgress(month, year, totalDias, diasCompletos) {
    const pct = diasCompletos / totalDias;
    const bar = document.getElementById(`reward-bar-${month}-${year}`);
    const unlocked = document.getElementById(`reward-unlocked-${month}-${year}`);
    if(bar) {
      bar.style.width = (pct * 100) + "%";
      if(pct === 1) {
        if(unlocked.style.display !== "block") {
          unlocked.style.display = "block";
          launchRewardConfetti();
        }
      } else {
        unlocked.style.display = "none";
      }
    }
  }
  function updateBirthdayRewardProgress(diasCompletos) {
    const bar = document.getElementById(`reward-bar-birthday`);
    const unlocked = document.getElementById(`reward-unlocked-birthday`);
    if(bar) {
      bar.style.width = (diasCompletos ? 100 : 0) + "%";
      if(diasCompletos) {
        unlocked.style.display = "block";
        launchRewardConfetti();
      } else {
        unlocked.style.display = "none";
      }
    }
  }

  // Toggle de dropdown para cada linha (clicando na linha da barra)
  document.querySelectorAll('.progress-row').forEach(row => {
    row.addEventListener('click', function(e) {
      const dayId = this.getAttribute('data-dayid');
      const dropdown = document.getElementById(`dropdown-${dayId}`);
      if (dropdown.classList.contains('active')) {
        dropdown.classList.remove('active');
        dropdown.classList.add('drop-up');
        setTimeout(() => dropdown.classList.remove('drop-up'), 400);
      } else {
        document.querySelectorAll('.dropdown.active').forEach(dd => {
          dd.classList.remove('active');
          dd.classList.add('drop-up');
          setTimeout(() => dd.classList.remove('drop-up'), 400);
        });
        dropdown.classList.add('active');
        dropdown.classList.remove('drop-up');
      }
    });
  });

  // Atualiza√ß√£o dos h√°bitos
  function checkAllHabitsComplete(dayId, habitCount) {
    let complete = true;
    for (let i = 0; i < habitCount; i++) {
      if (!document.getElementById(`${dayId}-habit-${i}`)?.checked) {
        complete = false;
        break;
      }
    }
    if (complete && !document.getElementById(`${dayId}-ciclico`)?.checked) complete = false;
    return complete;
  }
  function playCelebrateSound() {
    const audio = document.getElementById('celebrate-audio');
    audio.currentTime = 0;
    audio.volume = 0.97;
    let played = false;
    audio.play().then(() => { played = true; }).catch(() => {
      if (!played) {
        document.body.addEventListener('pointerdown', () => { audio.play(); }, { once: true });
      }
    });
  }
  document.querySelectorAll('.habit-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      const label = document.getElementById('label-' + this.id);
      if (label) label.classList.toggle('habit-done', this.checked);

      getProgress().then(progress => {
        progress[this.id] = this.checked;
        saveProgress(progress);
      });

      const hi = document.getElementById('habititem-' + this.id);
      if (hi) hi.classList.toggle('habit-complete', this.checked);
      const parts = this.id.match(/^dia-\d+-\d+-\d+/);
      if (parts) {
        const dayId = parts[0];
        const habitCount = document.querySelectorAll(`#dropdown-${dayId} .habit-checkbox`).length;
        updateProgressBar(dayId, habitCount);
        const allDone = checkAllHabitsComplete(dayId, habitCount - 1);
        if (allDone) {
          playCelebrateSound();
          launchConfettiEpic();
          unlockScroll();
        }
        // Atualizar barras de recompensa
        updateAllRewardProgress();
      }
    });
  });
  document.querySelectorAll('.habit-emoji').forEach(emoji => {
    emoji.addEventListener('mouseenter', function() {
      emoji.classList.add('glow');
      setTimeout(() => emoji.classList.remove('glow'), 680);
    });
    emoji.addEventListener('mouseleave', function() {
      emoji.classList.remove('glow');
    });
    emoji.addEventListener('click', function(e) {
      e.stopPropagation();
      const id = emoji.getAttribute('data-checkbox');
      const checkbox = document.getElementById(id);
      if (checkbox) {
        checkbox.checked = !checkbox.checked;
        checkbox.dispatchEvent(new Event('change'));
      }
    });
  });

  // Preencher barras de progresso e marcar completados
  dados.forEach((dia) => {
    const habitCount = dia.habitos.length + 1;
    updateProgressBar(dia.id, habitCount);
    const allDone = checkAllHabitsComplete(dia.id, habitCount - 1);
    if (allDone) {
      const row = document.getElementById(`progressrow-${dia.id}`);
      if (row) row.classList.add('day-complete');
    }
  });

  function updateAllRewardProgress() {
    // Atualiza a barra de cada m√™s
    Object.entries(grupos).forEach(([id, dias]) => {
      const [mes, ano] = id.split("-");
      const reward = getRewardFor(Number(mes), Number(ano));
      if (!reward) return;
      let diasCompletos = 0;
      dias.forEach((dia) => {
        const habitCount = dia.habitos.length + 1;
        const allDone = checkAllHabitsComplete(dia.id, habitCount - 1);
        if (allDone) diasCompletos++;
      });
      updateRewardProgress(mes, ano, dias.length, diasCompletos);
    });
    // Anivers√°rio
    if(document.getElementById("reward-bar-birthday")) {
      let birthdayDone = false;
      dados.forEach((dia)=>{
        if(dia.ano == 2025 && dia.mes == 8 && dia.diaDoMes == 21) {
          const habitCount = dia.habitos.length + 1;
          birthdayDone = checkAllHabitsComplete(dia.id, habitCount - 1);
        }
      });
      updateBirthdayRewardProgress(birthdayDone);
    }
  }
  updateAllRewardProgress();

  window.addEventListener('resize', function() {
    const canvas = document.getElementById('confetti-canvas');
    if (canvas.style.display === 'block') {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
  });

  // Confetti (sem altera√ß√£o)
  function launchConfettiEpic() {
    const canvas = document.getElementById('confetti-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    canvas.style.display = 'block';
    document.body.style.overflow = "hidden";
    let W = canvas.width, H = canvas.height;
    let particles = [];
    let colors = ['#ffe379','#e4c145','#f7e399','#FF522E','#fafff9','#FFD700','#FF69B4','#00E6F6','#82FF6A','#FF6666','#0ed156','#001130','#fd2a49'];
    for (let i = 0; i < 1200; i++) {
      particles.push({
        x: Math.random() * W,
        y: Math.random() * -H,
        r: 7 + Math.random() * 12,
        d: Math.random() * 180,
        color: colors[Math.floor(Math.random() * colors.length)],
        tilt: Math.random() * 16 - 8,
        tiltAngle: 0,
        tiltAngleIncremental: (Math.random() * 0.09) + .05,
        alpha: 0.84 + Math.random() * 0.16
      });
    }
    let angle = 0;
    function draw() {
      ctx.clearRect(0, 0, W, H);
      for (let i = 0; i < particles.length; i++) {
        ctx.beginPath();
        ctx.lineWidth = particles[i].r / 2;
        ctx.strokeStyle = particles[i].color;
        ctx.globalAlpha = particles[i].alpha;
        ctx.moveTo(particles[i].x + particles[i].tilt + particles[i].r / 4, particles[i].y);
        ctx.lineTo(particles[i].x + particles[i].tilt, particles[i].y + particles[i].r);
        ctx.stroke();
      }
      ctx.globalAlpha = 1;
      update();
    }
    function update() {
      angle += 0.008;
      for (let i = 0; i < particles.length; i++) {
        particles[i].y += (Math.cos(angle + particles[i].d) + 2.8 + particles[i].r/6) * 0.93;
        particles[i].x += Math.sin(angle * 1.18 + i) * 2.7;
        particles[i].tiltAngle += particles[i].tiltAngleIncremental;
        particles[i].tilt = Math.sin(particles[i].tiltAngle - (i % 3)) * 18;
        if (particles[i].y > H + 30) {
          particles[i].y = -14;
          particles[i].x = Math.random() * W;
        }
      }
    }
    let interval = setInterval(draw, 13);
    const celebrateText = document.getElementById('celebrate-text');
    celebrateText.style.display = 'block';
    setTimeout(() => {
      clearInterval(interval);
      ctx.clearRect(0, 0, W, H);
      canvas.style.display = 'none';
      celebrateText.style.display = 'none';
      unlockScroll();
    }, 4000);
  }
  function launchRewardConfetti() {
    const canvas = document.getElementById('reward-confetti');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    canvas.style.display = 'block';
    let W = canvas.width, H = canvas.height;
    let particles = [];
    let colors = ['#cf28ff', '#ff49e1', '#51ffe7', '#fff', '#9800cc', '#29012e'];
    for (let i = 0; i < 800; i++) {
      particles.push({
        x: Math.random() * W,
        y: Math.random() * -H,
        r: 8 + Math.random() * 10,
        d: Math.random() * 160,
        color: colors[Math.floor(Math.random() * colors.length)],
        tilt: Math.random() * 20 - 10,
        tiltAngle: 0,
        tiltAngleIncremental: (Math.random() * 0.07) + .06,
        alpha: 0.82 + Math.random() * 0.18
      });
    }
    let angle = 0;
    function draw() {
      ctx.clearRect(0, 0, W, H);
      for (let i = 0; i < particles.length; i++) {
        ctx.beginPath();
        ctx.lineWidth = particles[i].r / 2;
        ctx.strokeStyle = particles[i].color;
        ctx.globalAlpha = particles[i].alpha;
        ctx.moveTo(particles[i].x + particles[i].tilt + particles[i].r / 4, particles[i].y);
        ctx.lineTo(particles[i].x + particles[i].tilt, particles[i].y + particles[i].r);
        ctx.stroke();
      }
      ctx.globalAlpha = 1;
      update();
    }
    function update() {
      angle += 0.01;
      for (let i = 0; i < particles.length; i++) {
        particles[i].y += (Math.cos(angle + particles[i].d) + 2.5 + particles[i].r/6) * 0.84;
        particles[i].x += Math.sin(angle * 1.07 + i) * 2.3;
        particles[i].tiltAngle += particles[i].tiltAngleIncremental;
        particles[i].tilt = Math.sin(particles[i].tiltAngle - (i % 2)) * 19;
        if (particles[i].y > H + 30) {
          particles[i].y = -14;
          particles[i].x = Math.random() * W;
        }
      }
    }
    let interval = setInterval(draw, 13);
    setTimeout(() => {
      clearInterval(interval);
      ctx.clearRect(0, 0, W, H);
      canvas.style.display = 'none';
    }, 3400);
  }
});

  // Confetti especial (roxo) para recompensa
  function launchRewardConfetti() {
    const canvas = document.getElementById('reward-confetti');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    canvas.style.display = 'block';
    let W = canvas.width, H = canvas.height;
    let particles = [];
    let colors = ['#cf28ff', '#ff49e1', '#51ffe7', '#fff', '#9800cc', '#29012e'];
    for (let i = 0; i < 800; i++) {
      particles.push({
        x: Math.random() * W,
        y: Math.random() * -H,
        r: 8 + Math.random() * 10,
        d: Math.random() * 160,
        color: colors[Math.floor(Math.random() * colors.length)],
        tilt: Math.random() * 20 - 10,
        tiltAngle: 0,
        tiltAngleIncremental: (Math.random() * 0.07) + .06,
        alpha: 0.82 + Math.random() * 0.18
      });
    }
    let angle = 0;
    function draw() {
      ctx.clearRect(0, 0, W, H);
      for (let i = 0; i < particles.length; i++) {
        ctx.beginPath();
        ctx.lineWidth = particles[i].r / 2;
        ctx.strokeStyle = particles[i].color;
        ctx.globalAlpha = particles[i].alpha;
        ctx.moveTo(particles[i].x + particles[i].tilt + particles[i].r / 4, particles[i].y);
        ctx.lineTo(particles[i].x + particles[i].tilt, particles[i].y + particles[i].r);
        ctx.stroke();
      }
      ctx.globalAlpha = 1;
      update();
    }
    function update() {
      angle += 0.01;
      for (let i = 0; i < particles.length; i++) {
        particles[i].y += (Math.cos(angle + particles[i].d) + 2.5 + particles[i].r/6) * 0.84;
        particles[i].x += Math.sin(angle * 1.07 + i) * 2.3;
        particles[i].tiltAngle += particles[i].tiltAngleIncremental;
        particles[i].tilt = Math.sin(particles[i].tiltAngle - (i % 2)) * 19;
        if (particles[i].y > H + 30) {
          particles[i].y = -14;
          particles[i].x = Math.random() * W;
        }
      }
    }
    let interval = setInterval(draw, 13);
    setTimeout(() => {
      clearInterval(interval);
      ctx.clearRect(0, 0, W, H);
      canvas.style.display = 'none';
    }, 3400);
  }

 async function getProgress() {
    try {
      const doc = await db.collection("usuarios").doc("danilo").get();
      return doc.exists ? doc.data() : {};
    } catch (e) {
      console.error("Erro ao buscar dados do Firebase:", e);
      return JSON.parse(localStorage.getItem('habits-progress-v1')) || {};
    }
  }

  async function saveProgress(progress) {
    try {
      await db.collection("usuarios").doc("danilo").set(progress);
    } catch (e) {
      console.error("Erro ao salvar no Firebase:", e);
    }
    localStorage.setItem('habits-progress-v1', JSON.stringify(progress));
  }

 document.addEventListener("DOMContentLoaded", async function() {
  const progress = await getProgress();
    const dados = [];
    const habitos_incrementais = {
      1: ["Beber 2L de √°gua", "Tirar selfie", "Verificar peso"],
      5: ["Dieta com alimentos integrais"],
      9: ["Acordar √†s 5h"],
      13: ["Medita√ß√£o (10 min por dia)"],
      17: ["Exerc√≠cio (60 min)"],
      21: ["Leitura (30 min)"],
      25: ["Alimenta√ß√£o sem a√ß√∫car refinado"],
      29: ["Pr√°tica de italiano (20 min por dia)"]
    };
    const habitos_ciclicos = ["Afirma√ß√µes", "Banho gelado", "Exerc√≠cio de agilidade mental", "Di√°rio e gratid√£o"];
    const inicio = new Date(2025, 4, 21), fim = new Date(2025, 7, 21);
    const dias_total = Math.floor((fim - inicio) / (1000 * 60 * 60 * 24)) + 1;
    let habitos_ativos = [];
    for (let i = 1; i <= dias_total; i++) {
      const data_atual = new Date(inicio);
      data_atual.setDate(inicio.getDate() + i - 1);
      if (habitos_incrementais[i]) {
        habitos_ativos = habitos_ativos.concat(habitos_incrementais[i]);
      }
      const habito_ciclico = habitos_ciclicos[(i - 1) % 4];
      dados.push({
        data: data_atual.toLocaleDateString('pt-BR'),
        dia: `Dia ${i}`,
        habitos: [...habitos_ativos],
        ciclico: habito_ciclico,
        mes: data_atual.getMonth() + 1,
        ano: data_atual.getFullYear(),
        diaDoMes: data_atual.getDate(),
        id: `dia-${data_atual.getFullYear()}-${data_atual.getMonth()+1}-${data_atual.getDate()}`
      });
    }
    const calendario = document.getElementById("calendario");
    const grupos = {};
    dados.forEach((obj) => {
      const id = `${obj.mes}-${obj.ano}`;
      if (!grupos[id]) grupos[id] = [];
      grupos[id].push(obj);
    });
    let html = '';
    Object.entries(grupos).forEach(([id, dias]) => {
      const [mes, ano] = id.split("-");
      const mesNum = Number(mes);
      const anoNum = Number(ano);
      const nomeMes = monthNames[mesNum - 1].toUpperCase();

      // M√äS HEADER PRIMEIRO
      html += `<div class='mes'>${nomeMes} ${ano}</div>
      <table>
        <thead>
          <tr>
            <th></th>
            <th>Data</th>
            <th>Dia</th>
            <th>H√°bitos Di√°rios</th>
            <th>H√°bito C√≠clico</th>
          </tr>
        </thead>
        <tbody>`;
      dias.forEach((dia) => {
        const dayNum = parseInt(dia.dia.substring(4));
        let habitosCellText;
        if (dayNum <= 4) {
          habitosCellText = dia.habitos.join(', ');
        } else if (habitos_incrementais[dayNum]) {
          const newHabs = habitos_incrementais[dayNum];
          const totalBefore = dia.habitos.length - newHabs.length;
          habitosCellText = `${totalBefore} ${totalBefore > 1 ? 'h√°bitos' : 'h√°bito'} + ${newHabs.join(', ')}`;
        } else {
          const total = dia.habitos.length;
          habitosCellText = `${total} ${total > 1 ? 'h√°bitos' : 'h√°bito'}`;
        }
        html += `
<tr>
  <td colspan="5">
    <div class="progress-row" data-progress style="--progress:0.75">
      <div class="progress-bar-overlay"></div>
      <div class="progress-row-content">
        <div>DATA</div>
        <div>DIA</div>
        <div>H√ÅBITOS</div>
        <div>C√çCLICO</div>
      </div>
      <div class="progress-bar-overlay-text">
        <div>DATA</div>
        <div>DIA</div>
        <div>H√ÅBITOS</div>
        <div>C√çCLICO</div>
      </div>
    </div>
  </td>
</tr>
<tr class="dropdown">...</tr>
          <td colspan="5">
            <div class="habit-list">
              ${dia.habitos.map((h, idx) => `
                <div class="habit-item" id="habititem-${dia.id}-habit-${idx}">
                  <span class="habit-emoji" tabindex="0" data-checkbox="${dia.id}-habit-${idx}">${habitEmojis[idx % habitEmojis.length]}</span>
                  <label class="habit-label" for="${dia.id}-habit-${idx}" id="label-${dia.id}-habit-${idx}">${h}</label>
                  <input type="checkbox" class="habit-checkbox" id="${dia.id}-habit-${idx}">
                </div>
              `).join('')}
              <div class="habit-item" id="habititem-${dia.id}-ciclico">
                <span class="habit-emoji" tabindex="0" data-checkbox="${dia.id}-ciclico">${cycleEmojis[(dia.mes + dia.ano) % cycleEmojis.length]}</span>
                <label class="habit-label" for="${dia.id}-ciclico" id="label-${dia.id}-ciclico">${dia.ciclico}</label>
                <input type="checkbox" class="habit-checkbox" id="${dia.id}-ciclico">
              </div>
            </div>
          </td>
        </tr>`;
      });
      html += `</tbody></table>`;

      // Card de pr√™mio do m√™s (exceto anivers√°rio) DEPOIS do m√™s
      const reward = getRewardFor(mesNum, anoNum);
      if(reward) {
        html += `
        <div class="reward-card" data-reward="${mes}-${ano}">
          <div class="reward-icon">${reward.icon}</div>
          <div class="title">${reward.title}</div>
          <div class="desc">${reward.desc}</div>
          <div class="reward-bar-bg"><div class="reward-bar" id="reward-bar-${mes}-${ano}"></div></div>
          <div class="reward-unlocked" id="reward-unlocked-${mes}-${ano}" style="display:none">Pr√™mio desbloqueado: <span>${reward.label}</span></div>
        </div>`;
      }
      // Card de pr√™mio especial de anivers√°rio DEPOIS do m√™s agosto/2025
      if(mesNum === 8 && anoNum === 2025) {
        const annivReward = getRewardFor(mesNum, anoNum, 21);
        if(annivReward) {
          html += `
            <div class="reward-card" data-reward="birthday-2025">
              <div class="reward-icon">${annivReward.icon}</div>
              <div class="title">${annivReward.title}</div>
              <div class="desc">${annivReward.desc}</div>
              <div class="reward-bar-bg"><div class="reward-bar" id="reward-bar-birthday"></div></div>
              <div class="reward-unlocked" id="reward-unlocked-birthday" style="display:none">Pr√™mio desbloqueado: <span>${annivReward.label}</span></div>
            </div>
          `;
        }
      }
    });
    calendario.innerHTML = html;

Object.keys(progress).forEach(checkId => {
  const checkbox = document.getElementById(checkId);
  if (checkbox) {
    checkbox.checked = progress[checkId];
    const label = document.getElementById('label-' + checkId);
    if (label) label.classList.toggle('habit-done', progress[checkId]);
    const hi = document.getElementById('habititem-' + checkId);
    if (hi) hi.classList.toggle('habit-complete', progress[checkId]);
  }
});

    // Atualiza barra de progresso dourada por dia
    function updateProgressBar(dayId, habitCount) {
      let checked = 0;
      for (let i = 0; i < habitCount; i++) {
        if (document.getElementById(`${dayId}-habit-${i}`)?.checked) checked++;
      }
      if (document.getElementById(`${dayId}-ciclico`)?.checked) checked++;
      let pct = checked / habitCount;
      const row = document.getElementById(`mainrow-${dayId}`);
      if (row) {
        row.style.transition = 'background-size 0.7s cubic-bezier(.6,1.2,.16,1.08)';
        row.style.setProperty('--progress', pct);
        if (pct === 1) row.classList.add('day-complete');
        else row.classList.remove('day-complete');
      }
    }

    // Barra de progresso de recompensa por m√™s
    function updateRewardProgress(month, year, totalDias, diasCompletos) {
      const pct = diasCompletos / totalDias;
      const bar = document.getElementById(`reward-bar-${month}-${year}`);
      const unlocked = document.getElementById(`reward-unlocked-${month}-${year}`);
      if(bar) {
        bar.style.width = (pct * 100) + "%";
        if(pct === 1) {
          if(unlocked.style.display !== "block") {
            unlocked.style.display = "block";
            launchRewardConfetti();
          }
        } else {
          unlocked.style.display = "none";
        }
      }
    }
    // Barra de recompensa especial do anivers√°rio
    function updateBirthdayRewardProgress(diasCompletos) {
      const bar = document.getElementById(`reward-bar-birthday`);
      const unlocked = document.getElementById(`reward-unlocked-birthday`);
      if(bar) {
        bar.style.width = (diasCompletos ? 100 : 0) + "%";
        if(diasCompletos) {
          unlocked.style.display = "block";
          launchRewardConfetti();
        } else {
          unlocked.style.display = "none";
        }
      }
    }

    // Dropdown toggle
    document.querySelectorAll('tr.main-row').forEach(row => {
      row.addEventListener('click', function(e) {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'LABEL' || e.target.classList.contains('habit-emoji')) return;
        const dropdownId = this.getAttribute('data-dropdown');
        const dropdown = document.getElementById(`dropdown-${dropdownId}`);
        if (dropdown.classList.contains('active')) {
          dropdown.classList.remove('active');
          dropdown.classList.add('drop-up');
          setTimeout(() => dropdown.classList.remove('drop-up'), 400);
          this.classList.remove('expanded');
        } else {
          document.querySelectorAll('.dropdown.active').forEach(dd => {
            dd.classList.remove('active');
            dd.classList.add('drop-up');
            setTimeout(() => dd.classList.remove('drop-up'), 400);
            document.querySelector(`.main-row[data-dropdown="${dd.id.replace('dropdown-','')}"]`).classList.remove('expanded');
          });
          dropdown.classList.add('active');
          dropdown.classList.remove('drop-up');
          this.classList.add('expanded');
        }
      });
    });

    function checkAllHabitsComplete(dayId, habitCount) {
      let complete = true;
      for (let i = 0; i < habitCount; i++) {
        if (!document.getElementById(`${dayId}-habit-${i}`)?.checked) {
          complete = false;
          break;
        }
      }
      if (complete && !document.getElementById(`${dayId}-ciclico`)?.checked) complete = false;
      return complete;
    }

    function playCelebrateSound() {
      const audio = document.getElementById('celebrate-audio');
      audio.currentTime = 0;
      audio.volume = 0.97;
      let played = false;
      audio.play().then(() => { played = true; }).catch(() => {
        if (!played) {
          document.body.addEventListener('pointerdown', () => { audio.play(); }, { once: true });
        }
      });
    }

   document.querySelectorAll('.habit-checkbox').forEach(checkbox => {
  checkbox.addEventListener('change', function() {
    const label = document.getElementById('label-' + this.id);
    if (label) label.classList.toggle('habit-done', this.checked);

    getProgress().then(progress => {
      progress[this.id] = this.checked;
      saveProgress(progress);
    });

    const hi = document.getElementById('habititem-' + this.id);
    if (hi) hi.classList.toggle('habit-complete', this.checked);
        const parts = this.id.match(/^dia-\d+-\d+-\d+/);
        if (parts) {
          const dayId = parts[0];
          const habitCount = document.querySelectorAll(`#dropdown-${dayId} .habit-checkbox`).length;
          updateProgressBar(dayId, habitCount);
          const allDone = checkAllHabitsComplete(dayId, habitCount - 1);
          const dropdown = document.getElementById(`dropdown-${dayId}`);
          const dayRow = document.getElementById(`mainrow-${dayId}`);
          if (allDone) {
            dayRow.classList.add('day-complete');
            launchConfettiEpic();
            playCelebrateSound();
            setTimeout(() => {
              if (dropdown) {
                dropdown.classList.remove('active');
                dropdown.classList.add('drop-up');
                setTimeout(() => dropdown.classList.remove('drop-up'), 400);
              }
              if (dayRow) dayRow.classList.remove('expanded');
              unlockScroll();
            }, 950);
          } else {
            dayRow.classList.remove('day-complete');
          }
          // Atualizar barras de recompensa
          updateAllRewardProgress();
        }
      });
    });

    document.querySelectorAll('.habit-emoji').forEach(emoji => {
      emoji.addEventListener('mouseenter', function() {
        emoji.classList.add('glow');
        setTimeout(() => emoji.classList.remove('glow'), 680);
      });
      emoji.addEventListener('mouseleave', function() {
        emoji.classList.remove('glow');
      });
      emoji.addEventListener('click', function(e) {
        e.stopPropagation();
        const id = emoji.getAttribute('data-checkbox');
        const checkbox = document.getElementById(id);
        if (checkbox) {
          checkbox.checked = !checkbox.checked;
          checkbox.dispatchEvent(new Event('change'));
        }
      });
    });

    // Progress bar e checagem para todos os dias e pr√™mios!
    dados.forEach((dia) => {
      const habitCount = dia.habitos.length + 1;
      updateProgressBar(dia.id, habitCount);
      const allDone = checkAllHabitsComplete(dia.id, habitCount - 1);
      if (allDone) {
        const dayRow = document.getElementById(`mainrow-${dia.id}`);
        if (dayRow) dayRow.classList.add('day-complete');
      }
    });

    function updateAllRewardProgress() {
      // Atualiza a barra de cada m√™s
      Object.entries(grupos).forEach(([id, dias]) => {
        const [mes, ano] = id.split("-");
        const reward = getRewardFor(Number(mes), Number(ano));
        if (!reward) return;
        let diasCompletos = 0;
        dias.forEach((dia) => {
          const habitCount = dia.habitos.length + 1;
          const allDone = checkAllHabitsComplete(dia.id, habitCount - 1);
          if (allDone) diasCompletos++;
        });
        updateRewardProgress(mes, ano, dias.length, diasCompletos);
      });
      // Anivers√°rio
      if(document.getElementById("reward-bar-birthday")) {
        // S√≥ desbloqueia se dia 21/08/2025 for completado
        let birthdayDone = false;
        dados.forEach((dia)=>{
          if(dia.ano == 2025 && dia.mes == 8 && dia.diaDoMes == 21) {
            const habitCount = dia.habitos.length + 1;
            birthdayDone = checkAllHabitsComplete(dia.id, habitCount - 1);
          }
        });
        updateBirthdayRewardProgress(birthdayDone);
      }
    }
    updateAllRewardProgress();

    window.addEventListener('resize', function() {
      const canvas = document.getElementById('confetti-canvas');
      if (canvas.style.display === 'block') {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      }
    });
  });
</script>
</body>
</html>
